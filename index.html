<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>无人车</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <style>
        #container {
            height: 80%;
            width: 80%;
            /* margin-right: 0px; */
        }
    </style>
    <script type="text/javascript">
        function formSubmit() {
            document.getElementById("myForm").submit()
        }
    </script>
    <!-- <script type="text/javascript">
        function formSubmit2() {
            document.getElementById("myForm2").submit()
        }
    </script> -->

</head>

<body>
    <div style="float: left; height: 100%; width: 80%;">
        <div style="float: left; height: 300px;">
            <div>
                <form id="myForm" action="js_form_action.asp" method="get">
                    <!-- ID: <input type="text" name="id" size="20"><br /> -->
                    <!-- refPOS: <input type="text" name="refpos" size="20"><br /> -->
                    <!-- Radius: <input type="text" name="radius" size="20"><br /> -->
                    wayID: <input type="text" name="wayid" size="20"><br />
                    <!-- Section: <input type="text" name="section" size="20"><br /> -->
                    Name: <input type="text" name="name" size="20"><br />
                    <!-- Timestamp: <input type="text" name="timestamp" size="20"><br /> -->
                    <!-- State: <input type="text" name="state" size="20"><br /> -->
                    Direction: <input type="text" name="direction" size="20"><br />
                    State: <input type="text" name="state" size="20"><br />
                    <!-- Reason: <input type="text" name="reason" size="20"><br /> -->
                    <br>

                    <input type="button" onclick="formSubmit();" value="更改拥堵信息"> <br>
                </form>
            </div>



            <!-- <div>
                <form id='myForm2' action="js_form2_action.php" method="get">
                    wayID: <input type="text" name="delId" size="20"><br /><br>

                    <input type="button" onclick="formSubmit2()" value="删除拥堵信息"> <br>
                </form> 
             </div> -->
        </div>

        <br />

        <div id="container" style="float: right;"></div>
    </div>
    <script type="text/javascript" 
        src="https://webapi.amap.com/maps?v=1.4.15&key=d100aa3090ed93eb91ef822633442dea"></script>

    <script type="text/javascript">
        // 创建地图实例
        var map = new AMap.Map("container", {
            zoom: 17,
            zooms: [16, 20],
            center: [120.782382, 31.589128],
            resizeEnable: true,
            // expandZoomRange:true,
            rotation: 32
        });

        var bounds = new AMap.Bounds([120.771966, 31.566868], [120.793333, 31.608579]);
        map.setLimitBounds(bounds);

        var canvasDir = document.createElement('canvas')
        var width = 24;
        canvasDir.width = width;
        canvasDir.height = width;
        var context = canvasDir.getContext('2d');
        context.strokeStyle = 'white';
        context.lineJoin = 'round';
        context.lineWidth = 8;
        context.moveTo(-4, width - 4);
        context.lineTo(width / 2, 6);
        context.lineTo(width + 4, width - 4);
        context.stroke();

        map.setFitView();

        function createXhr() {
            if (window.XMLHttpRequest) {
                return new XMLHttpRequest();
            } else {
                return new ActiveXObject("Microsoft.XMLHTTP");
            }
        }
        var xhr = createXhr();
        xhr.open("post", "map.xml", true);

        wayIdList = new Array();

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var xmlDoc = xhr.responseXML;
                // 所有的<way>
                var wayList = xmlDoc.getElementsByTagName("way");
                // 所有的<node>
                var nodeList = xmlDoc.getElementsByTagName("node");
                var pathList = new Array();
                var crossroadList = new Array();

                for(var i = 0;i<27;i++){
                    //27个junction
                    var point = [nodeList[i].getAttribute("lon"), nodeList[i].getAttribute("lat")];
                    AMap.convertFrom(point, 'gps', function (status, result) {
                        if (result.info === 'ok') {
                            var resLnglat = result.locations[0];
                            m2 = new AMap.Marker({
                                position: resLnglat,
                            });
                            map.add(m2);
                        }
                    });
                }

                for (var i = 0; i < wayList.length; i++) {
                    if(wayList[i].getAttribute("action") != "delete"){
                        // <way>中的id
                        var wayId = wayList[i].getAttribute("id");
                        wayIdList.push(wayId);
                        // <way>的子标签
                        var subList = wayList[i].children;
                        var pointList = new Array();

                        if(wayId == "62687005700" || wayId == "62687005701" || wayId == "62687008900" || wayId == "62687008901"
                            || wayId == "62687008300" || wayId == "62687008301" || wayId == "62687008200" || wayId == "62687008201"){
                                
                            // 如果是这些弯道
                            var nodeIdList = new Array();
                            for (var j = 1; j < subList.length; j++) {
                                var ref = subList[j].getAttribute("ref");
                                if (ref != null) {
                                    var endNodeId = ref;
                                    startNodeId = subList[j - 1].getAttribute("ref");
                                    nodeIdList.push(startNodeId);
                                    nodeIdList.push(endNodeId);

                                    for (var l = 0; l < nodeIdList.length; l++) {
                                        for (var m = 0; m < nodeList.length; m++) {
                                            if (nodeList[m].getAttribute("action") != "delete" && nodeList[m].getAttribute("id") == nodeIdList[l]) {
                                                // pointList -> ((x1,y1),(x2,y2),(x2,y2),(x3,y3))
                                                pointList.push([nodeList[m].getAttribute("lon"), nodeList[m].getAttribute("lat")]);
                                                break;
                                            }
                                        }
                                    }
                                    
                                    for(var n = 0;n<pointList.length;n+=2){
                                        var onePath = [];
                                        onePath.push(pointList[n]);
                                        onePath.push(pointList[n+1]);
                                        pathList.push(onePath);
                                    }
                                    
                                }
                            }
                        }

                        else{
                            var nodeIdList = new Array();
                            var startNodeId = subList[0].getAttribute("ref");
                            for (var j = 1; j < subList.length; j++) {
                                var ref = subList[j].getAttribute("ref");
                                if (ref == null) {
                                    var endNodeId = subList[j - 1].getAttribute("ref");
                                    nodeIdList.push(startNodeId);
                                    nodeIdList.push(endNodeId);
                                    break;
                                }
                            }
                            for (var l = 0; l < nodeIdList.length; l++) {
                                for (var m = 0; m < nodeList.length; m++) {
                                    if (nodeList[m].getAttribute("action") != "delete" && nodeList[m].getAttribute("id") == nodeIdList[l]) {
                                        // pointList -> ((x1,y1),(x2,y2))
                                        pointList.push([nodeList[m].getAttribute("lon"), nodeList[m].getAttribute("lat")]);
                                        break;
                                    }
                                }
                            }
                            var onePath = [];
                            onePath.push(pointList[0]);
                            onePath.push(pointList[1]);
                            pathList.push(onePath);
                        }
                    }
                }
                for (var i = 0; i < pathList.length; i++) {
                    var msgInJSON = {
                        path: pathList[i],
                        strokeColor: 'green',
                        extData: [wayIdList[i], 0]
                    }

                    var str = JSON.stringify(msgInJSON);
                    sessionStorage.setItem(i, str);
                    
                    AMap.convertFrom(pathList[i], 'gps', function (status, result) {
                        if (result.info === 'ok') {
                            var path2 = result.locations;
                            var polyline = new AMap.Polyline({
                                map:map,
                                path: path2,
                                showDir: true,
                                dirImg: canvasDir,
                                borderWeight: 2, // 线条宽度，默认为 1
                                strokeColor: 'green', // 线条颜色
                                lineJoin: 'round', // 折线拐点连接处样式
                                strokeWeight: 8,           // 线宽
                                extData: [wayIdList[i], 0]
                            });
                        }
                    });
                }
            }
        }

        xhr.send(null);

        var xhr2 = createXhr();
        xhr2.open("post", "testInfo.xml", true);
        xhr2.onreadystatechange = function () {
            if (xhr2.readyState == 4 && xhr2.status == 200) {
                var xmlDoc = xhr2.responseXML;
                // console.log(xmlDoc);
                // console.log('hello');
            }
        }
        xhr2.send(null);
        
        window.onload = function () {
            var xmlDoc = xhr2.responseXML;
            var carInfo=[];
            var userWayIdList = xmlDoc.getElementsByTagName("way");
            for(var i = 0;i<userWayIdList.length;i++){
                carInfo.push(userWayIdList[i].getAttribute("id") ) + userWayIdList[i].getAttribute("dir");
            }

            for (var j = 0; j < 190; j++) {
                var data = sessionStorage.getItem(j);
                var polyline = new AMap.Polyline({
                    path: JSON.parse(data).path,
                    showDir: true,
                    dirImg: canvasDir,
                    borderWeight: 2, // 线条宽度，默认为 1
                    strokeColor: JSON.parse(data).strokeColor, // 线条颜色
                    lineJoin: 'round', // 折线拐点连接处样式
                    strokeWeight: 8,           // 线宽
                    extData: JSON.parse(data).extData
                });
                //当前是绿色路段
                if (polyline.getExtData()[1] == 0) {
                    for (var i = 0; i < carInfo.length; i++) {
                        var wayId = carInfo[i];
                        if (polyline.getExtData()[0] == wayId) {
                            // polylineList[j].getExtData()[1] = 1;
                            // var newPath = polylineList[j].getPath();
                            // if (carInfo[i].Direction == 0) {
                            //     var temp = newPath[0];
                            //     newPath[0] = newPath[1];
                            //     newPath[1] = temp;
                            // }
                            map.remove(polyline);

                            var newPolyline;
                            var startPoint = new AMap.LngLat(polyline.getPath()[0].R, polyline.getPath()[0].Q)
                            var endPoint = new AMap.LngLat(polyline.getPath()[1].R, polyline.getPath()[1].Q)
                            var path = [startPoint,endPoint];
                            AMap.convertFrom(path, 'gps', function (status, result) {

                                if (result.info === 'ok') {
                                    var path2 = result.locations;
                                    newPolyline = new AMap.Polyline({
                                        path: path2,
                                        showDir: true,
                                        dirImg: canvasDir,
                                        borderWeight: 2, // 线条宽度，默认为 1
                                        strokeColor: 'red', // 线条颜色
                                        lineJoin: 'round', // 折线拐点连接处样式
                                        strokeWeight: 8,           // 线宽
                                        extData: [wayIdList[j], 1]
                                    });

                                    var msgInJSON = {
                                        path: path2,
                                        strokeColor: 'red',
                                        extData: [wayIdList[j], 1]
                                    }
                                    var str = JSON.stringify(msgInJSON);
                                    sessionStorage.setItem(j, str);

                                    map.add(newPolyline);
                                }

                            });
                        }
                    }
                }
                //当前是红色路段
                else{
                    var i = 0;
                    for (; i < carInfo.length; i++) {
                        var wayId = carInfo[i];
                        if (polyline.getExtData()[0] == wayId) {
                            break;
                        }
                    }
                    if(i == carInfo.length){
                        // polylineList[j].getExtData()[1] = 0;
                        // var newPath = polylineList[j].getPath();
                        // if (carInfo[i].Direction == 0) {
                        //     var temp = newPath[0];
                        //     newPath[0] = newPath[1];
                        //     newPath[1] = temp;
                        // }
                        map.remove(polyline);
                        
                        var newPolyline;
                        var startPoint = new AMap.LngLat(polyline.getPath()[0].R, polyline.getPath()[0].Q)
                        var endPoint = new AMap.LngLat(polyline.getPath()[1].R, polyline.getPath()[1].Q)
                        var path = [startPoint, endPoint];
                        AMap.convertFrom(path, 'gps', function (status, result) {
                            if (result.info === 'ok') {
                                var path2 = result.locations;
                                newPolyline = new AMap.Polyline({
                                    path: path2,
                                    showDir: true,
                                    dirImg: canvasDir,
                                    borderWeight: 2, // 线条宽度，默认为 1
                                    strokeColor: 'green', // 线条颜色
                                    lineJoin: 'round', // 折线拐点连接处样式
                                    strokeWeight: 8,           // 线宽
                                    extData: [wayIdList[j], 0]
                                });
                                
                                var msgInJSON = {
                                    path: path2,
                                    strokeColor: 'green',
                                    extData: [wayIdList[j], 0]
                                }
                                var str = JSON.stringify(msgInJSON);
                                sessionStorage.setItem(j, str);

                                map.add(newPolyline);
                            }
                        });
                    }
                }
            }
        }
    </script>
</body>

</html>