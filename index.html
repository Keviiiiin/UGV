<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>无人车</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <link href="bootstrap.min.css" rel="stylesheet" />
    <script src="jquery-3.5.1.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <style>
        #container {
            height: 80%;
            width: 80%;
            /* margin-right: 0px; */
        }
    </style>
    <script type="text/javascript">
        function formSubmit() {
            document.getElementById("myForm").submit();
        }
    </script>
    <!-- <script type="text/javascript">
        function formSubmit2() {
            document.getElementById("myForm2").submit()
        }
    </script> -->

</head>
<script language="javascript">

    function changeProvince() {

        var slecctS = document.querySelectorAll(".form-control");

        var countrys = new Array();

        countrys["0"] = ["--请选择道路序号--"];

        countrys["62687008000"] = ["消防通道"];
        countrys["62687008001"] = ["消防通道"];
        countrys["62687008200"] = ["园区北路"];
        // countrys["62687008201"] = ["园区北路"];
        countrys["62687008300"] = ["园区东路"];
        countrys["62687008301"] = ["园区东路"];
        countrys["62687008400"] = ["园区南路"];
        countrys["62687008401"] = ["园区南路"];
        countrys["62687008500"] = ["地下停车场入口"];
        countrys["62687008501"] = ["地下停车场入口"];
        countrys["62687008100"] = ["园区南路"];
        countrys["62687008101"] = ["园区南路"];
        countrys["62687008700"] = ["园区南路"];
        countrys["62687008701"] = ["园区南路"];
        countrys["62687008600"] = ["内部道路出口"];
        countrys["62687008800"] = ["内部道路入口"];
        countrys["62687008900"] = ["园区西路"];
        countrys["62687008901"] = ["园区西路"];
        countrys["62687009100"] = ["园区西路"];
        // countrys["62687009101"] = ["园区西路"];
        countrys["62687009200"] = ["园区中路"];
        // countrys["62687009201"] = ["园区中路"];
        countrys["62687009000"] = ["迎宾通道"];
        countrys["62687006100"] = ["云深路"];
        countrys["62687006101"] = ["云深路"];
        countrys["62687009300"] = ["云深路"];
        countrys["62687009300"] = ["云深路"];
        countrys["62687005800"] = ["云深路"];
        countrys["62687005801"] = ["云深路"];
        countrys["62687005700"] = ["云深路"];
        countrys["62687005701"] = ["云深路"];
        countrys["62687003800"] = ["五渠路"];
        countrys["62687003801"] = ["五渠路"];
        countrys["62687003300"] = ["五渠路"];
        countrys["62687003301"] = ["五渠路"];
        countrys["62687004000"] = ["五渠路"];
        countrys["62687004001"] = ["五渠路"];
        countrys["62687004300"] = ["渔乐路"];
        countrys["62687004301"] = ["渔乐路"];
        countrys["62687005000"] = ["渔乐路"];
        countrys["62687005001"] = ["渔乐路"];
        countrys["62687005200"] = ["渔乐路"];
        countrys["62687005201"] = ["渔乐路"];
        countrys["62687010700"] = ["黄浦江路"];
        countrys["62687005400"] = ["福茂路"];
        countrys["62687005401"] = ["福茂路"];
        countrys["62687010300"] = ["福茂路"];
        countrys["62687010301"] = ["福茂路"];
        countrys["62687009800"] = ["福茂路"];
        countrys["62687009801"] = ["福茂路"];
        countrys["62687010200"] = ["福茂路"];
        countrys["62687010201"] = ["福茂路"];
        countrys["62687003200"] = ["福盛路"];
        countrys["62687003201"] = ["福盛路"];
        countrys["62687011000"] = ["福盛路"];
        countrys["62687011001"] = ["福盛路"];
        countrys["62687002700"] = ["福盛路"];
        countrys["62687002701"] = ["福盛路"];
        countrys["62687002500"] = ["福兴路"];
        countrys["62687002501"] = ["福兴路"];
        countrys["62687002200"] = ["福兴路"];
        countrys["62687002201"] = ["福兴路"];
        countrys["62687002100"] = ["福兴路"];
        countrys["62687002101"] = ["福兴路"];
        countrys["62687011600"] = ["湖山路"];
        countrys["62687011700"] = ["湖山路"];
        countrys["62687012000"] = ["湖山路"];
        countrys["62687012200"] = ["湖山路"];





        // countrys["园区东路"] = ["626870083"];
        // countrys["园区南路"] = ["626870081", "626870084","626870087"];
        // countrys["园区西路"] = ["626870089", "626870091"];
        // countrys["园区北路"] = ["626870082"];
        // countrys["园区中路"] = ["626870092"];

        // countrys["地下停车场入口"] = ["626870085"];
        // countrys["内部道路出口"] = ["626870086"];
        // countrys["内部道路入口"] = ["626870088"];
        
        // countrys["云深路"] = ["626870061","626870093","626870058", "626870057"];
        // countrys["五渠路"] = ["626870038", "626870033", "626870040"];
        // countrys["渔乐路"] = ["626870043", "626870050", "626870052"];
        // countrys["黄浦江路"] = ["626870107"];
        // countrys["福茂路"] = ["626870054", "626870103" ,"626870098","626870102"];
        // countrys["福盛路"] = ["626870032", "626870110", "626870027"];
        // countrys["福兴路"] = ["626870025", "626870022", "626870021"];
        // countrys["湖山路"] = ["626870116", "626870117", "626870120","626870122"];

        var value = slecctS[0].value;

        //option 集合可返回包含 <select> 元素中所有 <option> 的一个数组。

        //注意： 数组中的每个元素对应一个 <option> 标签 - 由 0 起始。 

        slecctS[1].options.length = 0;

        var option;

        for (i = 0; i < countrys[value].length; i++) {

            //new Option("文本","值",true,true)

            //后面两个true分别表示默认被选中和有效!



            option = new Option(countrys[value][i], countrys[value][i]);

            slecctS[1].options.add(option);

            slecctS[1].options.selected = countrys[value][0];

        }

        if (slecctS[0].value == "0") {

            slecctS[1].disabled = true;

        }

        else {

            slecctS[1].disabled = false;

        }

    }

</script>
<body>
    <div style="float: left; height: 100%; width: 70%;">
        <div style="float: left; ">
                <form id="myForm" action="js_form_action.asp" method="get">
                    <!-- ID: <input type="text" name="id" size="20"><br /> -->
                    <!-- refPOS: <input type="text" name="refpos" size="20"><br /> -->
                    <!-- Radius: <input type="text" name="radius" size="20"><br /> -->
                    <h3>道路名称</h3><select name="wayid" class="form-control" onChange="changeProvince()" >
                        <option>--请选择道路序号--</option>
                        <option value="62687008000">1-消防通道</option>
                        <option value="62687008001">2-消防通道</option>
                        <option value="62687008200">3-园区北路</option>
                        <option value="62687008300">4-园区东路</option>
                        <option value="62687008301">5-园区东路</option>
                        <option value="62687008400">6-园区南路</option>
                        <option value="62687008401">7-园区南路</option>
                        <option value="62687008500">8-地下停车场入口</option>
                        <option value="62687008501">9-地下停车场入口</option>
                        <option value="62687008100">10-园区南路</option>
                        <option value="62687008101">11-园区南路</option>
                        <option value="62687008700">12-园区南路</option>
                        <option value="62687008701">13-园区南路</option>
                        <option value="62687008600">14-内部道路出口</option>
                        <option value="62687008800">15-内部道路入口</option>
                        <option value="62687008900">16-园区西路</option>
                        <option value="62687008901">17-园区西路</option>
                        <option value="62687009100">18-园区西路</option>
                        <option value="62687009200">19-园区中路</option>
                        <option value="62687009000">20-迎宾通道</option>
                        <option value="62687006100">21-云深路</option>
                        <option value="62687006101">22-云深路</option>
                        <option value="62687009300">23-云深路</option>
                        <option value="62687009301">24-云深路</option>
                        <option value="62687005800">25-云深路</option>
                        <option value="62687005801">26-云深路</option>
                        <option value="62687005700">27-云深路</option>
                        <option value="62687005701">28-云深路</option>
                        <option value="62687003800">29-五渠路</option>
                        <option value="62687003801">30-五渠路</option>
                        <option value="62687003300">31-五渠路</option>
                        <option value="62687003301">32-五渠路</option>
                        <option value="62687004000">33-五渠路</option>
                        <option value="62687004001">34-五渠路</option>
                        <option value="62687004300">35-渔乐路</option>
                        <option value="62687004301">36-渔乐路</option>
                        <option value="62687005000">37-渔乐路</option>
                        <option value="62687005001">38-渔乐路</option>
                        <option value="62687005200">39-渔乐路</option>
                        <option value="62687005201">40-渔乐路</option>
                        <option value="62687010700">41-黄浦江路</option>
                        <option value="62687005400">42-福茂路</option>
                        <option value="62687005401">43-福茂路</option>
                        <option value="62687010300">44-福茂路</option>
                        <option value="62687010301">45-福茂路</option>
                        <option value="62687009800">46-福茂路</option>
                        <option value="62687009801">47-福茂路</option>
                        <option value="62687010200">48-福茂路</option>
                        <option value="62687010201">49-福茂路</option>
                        <option value="62687003200">50-福盛路</option>
                        <option value="62687003201">51-福盛路</option>
                        <option value="62687011000">52-福盛路</option>
                        <option value="62687011001">53-福盛路</option>
                        <option value="62687002700">54-福盛路</option>
                        <option value="62687002701">55-福盛路</option>
                        <option value="62687002500">56-福兴路</option>
                        <option value="62687002501">57-福兴路</option>
                        <option value="62687002200">58-福兴路</option>
                        <option value="62687002201">59-福兴路</option>
                        <option value="62687002100">60-福兴路</option>
                        <option value="62687002101">61-福兴路</option>
                        <option value="62687011600">62-湖山路</option>
                        <option value="62687011700">63-湖山路</option>
                        <option value="62687012000">64-湖山路</option>
                        <option value="62687012200">65-湖山路</option>
                    </select>
                    
                        <br/><br />
                    <!-- Section: <input type="text" name="section" size="20"><br /> -->
                    <select name="name" class="form-control" style="display: none;">
                        <option>--道路id--</option>
                    </select>
                    <br /><br />
                    <!-- Timestamp: <input type="text" name="timestamp" size="20"><br /> -->
                    <!-- State: <input type="text" name="state" size="20"><br /> -->
                    <!-- <h3>方向</h3><select name="direction" >
                        <option value="0">0-正向</option>
                        <option value="1">1-反向</option>
                    </select> -->
                    <h3>状态</h3><select name="state" class="form-control">
                        <option value="0">0-畅通</option>
                        <option value="1">1-缓慢</option>
                        <option value="2">2-拥堵</option>
                    </select>
                    <!-- Reason: <input type="text" name="reason" size="20"><br /> -->
                    <br /><br />

                    <input type="button" onclick="formSubmit();" value="更改拥堵信息"> <br /><br />
                </form>



            <!-- <div>
                <form id='myForm2' action="js_form2_action.php" method="get">
                    wayID: <input type="text" name="delId" size="20"><br /><br>

                    <input type="button" onclick="formSubmit2()" value="删除拥堵信息"> <br>
                </form> 
             </div> -->
        </div>


        <div id="container" style="float: right;"></div>
    </div>
    <script type="text/javascript" 
        src="https://webapi.amap.com/maps?v=1.4.15&key=d100aa3090ed93eb91ef822633442dea"></script>

    <script type="text/javascript">
        // 创建地图实例
        var map = new AMap.Map("container", {
            zoom: 16,
            zooms: [16, 20],
            center: [120.782382, 31.589128],
            resizeEnable: true,
            // expandZoomRange:true,
            // rotation: 32,
            features: 'road'
        });

        var bounds = new AMap.Bounds([120.771966, 31.566868], [120.793333, 31.608579]);
        map.setLimitBounds(bounds);

        var canvasDir = document.createElement('canvas')
        var width = 24;
        canvasDir.width = width;
        canvasDir.height = width;
        var context = canvasDir.getContext('2d');
        context.strokeStyle = 'white';
        context.lineJoin = 'round';
        context.lineWidth = 8;
        context.moveTo(-4, width - 4);
        context.lineTo(width / 2, 6);
        context.lineTo(width + 4, width - 4);
        context.stroke();

        map.setFitView();

        function createXhr() {
            if (window.XMLHttpRequest) {
                return new XMLHttpRequest();
            } else {
                return new ActiveXObject("Microsoft.XMLHTTP");
            }
        }
        var xhr = createXhr();
        xhr.open("post", "map.xml", false);

        

        // if(sessionStorage.length == 0){
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var xmlDoc = xhr.responseXML;
                // 所有的<way>
                var wayList = xmlDoc.getElementsByTagName("way");
                // 所有的<node>
                var nodeList = xmlDoc.getElementsByTagName("node");
                var pathList = new Array();
                var specialPath = new Array();
                // var pathArray = new Array();
                var pathMap = new Map();
                var wayIdList = new Array();
                for(var i = 0;i<9;i++){
                    //8个junction
                    var point = [nodeList[i].getAttribute("lon"), nodeList[i].getAttribute("lat")];
                    AMap.convertFrom(point, 'gps', function (status, result) {
                        if (result.info === 'ok') {
                            var resLnglat = result.locations[0];

                            // if(i>7) i = 0;
                            // var pointInJSON = {
                            //     position: resLnglat
                            // };
                            // var point = JSON.stringify(pointInJSON);
                            // sessionStorage.setItem(i,point);
                            // i++;

                            // var junctionIcon = new AMap.Icon({
                            //     size: new AMap.Size(30,30),
                            //     image: "//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png",
                            //     imageSize: new AMap.Size(10, 20),
                            // });
                            m2 = new AMap.Marker({
                                // icon: junctionIcon,
                                // offset: new AMap.Pixel(-13, -30),
                                position: resLnglat,
                            });
                            map.add(m2);
                        }
                    });
                }
// var index = 0;
                for (var i = 0; i < wayList.length; i++) {
                    if(wayList[i].getAttribute("action") != "delete"){
                        //共80条
                        // index++;
                        // <way>中的id
                        var wayId = wayList[i].getAttribute("id");
                        
                        // <way>的子标签
                        var subList = wayList[i].children;
                        var pointList = new Array();

                        if(wayId == "62687005700" || wayId == "62687005701" || wayId == "62687008900" || wayId == "62687008901"
                            || wayId == "62687008200" || wayId == "62687009000")
                        {
                            // 如果是这些6条弯道
                            specialPath.push(wayId);
                            // console.log(specialPath);
                            var nodeIdList = new Array();
                            for (var j = 1; j < subList.length; j++) {
                                var ref = subList[j].getAttribute("ref");
                                if (ref != null) {
                                    var endNodeId = ref;
                                    startNodeId = subList[j - 1].getAttribute("ref");
                                    nodeIdList.push(startNodeId);
                                    nodeIdList.push(endNodeId);
                                }
                            }
                            for (var l = 0; l < nodeIdList.length; l++) {
                                for (var m = 0; m < nodeList.length; m++) {
                                    if (nodeList[m].getAttribute("action") != "delete" && nodeList[m].getAttribute("id") == nodeIdList[l]) {
                                        // pointList -> ((x1,y1),(x2,y2),(x2,y2),(x3,y3))
                                        pointList.push([nodeList[m].getAttribute("lon"), nodeList[m].getAttribute("lat")]);
                                        break;
                                    }
                                }
                            }
                            var pathArray = new Array();
                            for(var n = 0;n<pointList.length;n+=2){
                                var onePath = [];
                                onePath.push(pointList[n]);
                                onePath.push(pointList[n+1]);
                                pathArray.push(onePath);
                            }
                            pathMap.set(wayId,pathArray);
                        }
                        
                        else{
                            wayIdList.push(wayId);
                            var nodeIdList = new Array();
                            var startNodeId = subList[0].getAttribute("ref");
                            for (var j = 1; j < subList.length; j++) {
                                var ref = subList[j].getAttribute("ref");
                                if (ref == null) {
                                    var endNodeId = subList[j - 1].getAttribute("ref");
                                    nodeIdList.push(startNodeId);
                                    nodeIdList.push(endNodeId);
                                    break;
                                }
                            }
                            for (var l = 0; l < nodeIdList.length; l++) {
                                for (var m = 0; m < nodeList.length; m++) {
                                    if (nodeList[m].getAttribute("action") != "delete" && nodeList[m].getAttribute("id") == nodeIdList[l]) {
                                        // pointList -> ((x1,y1),(x2,y2))
                                        pointList.push([nodeList[m].getAttribute("lon"), nodeList[m].getAttribute("lat")]);
                                        break;
                                    }
                                }
                            }
                            var onePath = [];
                            onePath.push(pointList[0]);
                            onePath.push(pointList[1]);
                            pathList.push(onePath);
                        }
                        // console.log(wayIdList);
                    }

                }
                // console.log(pathList.length);
                // console.log(index);
                for (var i = 0; i < pathList.length; i++) {
                    // console.log(wayIdList[i],pathList[i]);
                    AMap.convertFrom(pathList[i], 'gps', function (status, result) {
                        if (result.info === 'ok') {
                            var path2 = result.locations;

                            //75条单一wayid
                            if(i > 72) i = 0;
                            var msgInJSON = {
                                path: path2,
                                strokeColor: 'green',
                                extData: 0 // 0-畅通,1-拥堵
                            };
                            var str = JSON.stringify(msgInJSON);
                            sessionStorage.setItem(wayIdList[i], str);
                            // console.log(i);
                            i++;
                        
                            var polyline = new AMap.Polyline({
                                map:map,
                                path: path2,
                                showDir: true,
                                dirImg: canvasDir,
                                borderWeight: 2, // 线条宽度，默认为 1
                                strokeColor: 'green', // 线条颜色
                                lineJoin: 'round', // 折线拐点连接处样式
                                strokeWeight: 8,           // 线宽
                            });
                        }
                    });
                }
                // {"wayid":[路径1,路径2,路径3];"wayid":[a,b,c]}
                
                for(var k = 0;k<specialPath.length;k++){                
                    var specialArray = pathMap.get(specialPath[k]);
                    // if(specialArray.length == 3)
                        // console.log(specialPath[k]);
                    for(var j = 0;j<specialArray.length;j++){
                        var x = 10000;
                        var s = specialPath[k];
                        // console.log(s);
                        AMap.convertFrom(specialArray[j], 'gps', function (status, result) {
                            if (result.info === 'ok') {
                                var path2 = result.locations;
                                    var msgInJSON = {
                                        path: path2,
                                        strokeColor: 'green',
                                        extData: 0 // 0-畅通,1-拥堵
                                    };
                                    var str = JSON.stringify(msgInJSON);
                                    sessionStorage.setItem(x, str);
                                    // console.log(x);
                                    x++;
                                // console.log(s);
                                

                                var polyline = new AMap.Polyline({
                                    map: map,
                                    path: path2,
                                    showDir: true,
                                    dirImg: canvasDir,
                                    borderWeight: 2, // 线条宽度，默认为 1
                                    strokeColor: 'green', // 线条颜色
                                    lineJoin: 'round', // 折线拐点连接处样式
                                    strokeWeight: 8,           // 线宽
                                });
                            }
                        });
                    }
                }
            }
        }

        xhr.send(null);
    // }
    // else{


        var xhr2 = createXhr();
        xhr2.open("post", "testInfo.xml", false);
        xhr2.onreadystatechange = function () {
            if (xhr2.readyState == 4 && xhr2.status == 200) {
                var xmlDoc = xhr2.responseXML;
                // console.log(xmlDoc);
                // console.log('hello');
            }
        }
        xhr2.send(null);
        
        window.onload = function () {
            // for(var i = 0;i<8;i++){
            //     // console.log(JSON.parse(sessionStorage.getItem(i)));
            //     var m = new AMap.Marker({
            //         position: JSON.parse(sessionStorage.getItem(i)).position
            //     });
            //     map.add(m);
            // }
            
            var xmlDoc = xhr2.responseXML;
            var userWayIdList = xmlDoc.getElementsByTagName("way");
            // console.log(userWayIdList);
            for(var i = 0;i<userWayIdList.length;i++){
                
                var userWayId = userWayIdList[i].getAttribute("id") + "0" + userWayIdList[i].getAttribute("dir");
                // console.log(userWayId);
                var special = new Array(2);
                
                if (userWayId == "62687005700") {
                    special[0]=10000;
                    special[1]=6;
                }
                else if (userWayId == "62687005701") {
                    special[0]=10006;
                    special[1]=6;
                }
                // else if (userWayId == "62687008300") {
                //     special[0]=10004;
                //     special[1]=2;
                // }
                // else if (userWayId == "62687008301") {
                //     special[0]=10006;
                //     special[1]=2;
                // }
                else if (userWayId == "62687008200") {
                    special[0]=10012;
                    special[1]=2;
                }
                else if (userWayId == "62687008900") {
                    special[0]=10014;
                    special[1]=2;
                }
                else if (userWayId == "62687008901") {
                    special[0] = 10016;
                    special[1] = 2;
                }
                else if (userWayId == "62687009000") {
                    special[0] = 10018;
                    special[1] = 3;
                }
                // else{
                //     special[0] = null;
                // }
                var state = userWayIdList[i].getAttribute("state");
                var color = "";
                if (state == "0") {color = "green";}
                else if (state == "1") {color = "yellow";}
                else if (state == "2") {color = "red";}

                if(special[0] != null){
                    userWayId = special[0];

                    for(var j = 0;j<special[1];userWayId++,j++){
                        ses = JSON.parse(sessionStorage.getItem(userWayId));
                        // if (ses == null)
                        //     console.log(userWayId);
                        // console.log(ses);
                        var newPolyline = new AMap.Polyline({
                            map:map,
                            path: ses.path,
                            showDir: true,
                            dirImg: canvasDir,
                            borderWeight: 2, // 线条宽度，默认为 1
                            strokeColor: color, // 线条颜色
                            lineJoin: 'round', // 折线拐点连接处样式
                            strokeWeight: 8,           // 线宽
                        });
                        // if (color == "red")
                        //     console.log(path);
                        var msgInJSON = {
                            path: ses.path,
                            strokeColor: color,
                            extData: state
                        }
                        var str = JSON.stringify(msgInJSON);
                        sessionStorage.setItem(userWayId, str);

                        // map.add(newPolyline);
                    }
                }
                else{
                    var data = sessionStorage.getItem(userWayId);
                    ses = JSON.parse(data);

                    // console.log(ses);

                    if(data == null)
                        console.log(userWayId);
                    var path = ses.path;

                    // if(color == "yellow")
                    // console.log(userWayId,path);

                    var newPolyline = new AMap.Polyline({
                        map:map,
                        path: path,
                        showDir: true,
                        dirImg: canvasDir,
                        borderWeight: 2, // 线条宽度，默认为 1
                        strokeColor: color, // 线条颜色
                        lineJoin: 'round', // 折线拐点连接处样式
                        strokeWeight: 8,           // 线宽
                    });

                    var msgInJSON = {
                        path: path,
                        strokeColor: color,
                        extData: state
                    }
                    var str = JSON.stringify(msgInJSON);
                    sessionStorage.setItem(userWayId, str);

                    // map.add(newPolyline);
                }
                
            }

        }
        
    // }
    </script>
</body>

</html>